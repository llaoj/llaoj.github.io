<!doctype html><html lang=zh dir=ltr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Apisxi Ingress Controller 设计说明">
<meta name=theme-color content="#FFFFFF">
<meta name=color-scheme content="light dark"><meta property="og:title" content="Apisxi Ingress Controller 设计说明">
<meta property="og:description" content="Apisxi Ingress Controller 设计说明">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.llaoj.cn/posts/2204/apisix-ingress-controller-design/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-04-14T00:00:00+00:00">
<meta property="article:modified_time" content="2022-04-14T00:00:00+00:00">
<title>Apisxi Ingress Controller 设计说明 | 老J的博客</title>
<link rel=manifest href=/manifest.json>
<link rel=icon href=/favicon.png type=image/x-icon>
<link rel=stylesheet href=/book.min.18b5d651e266e5e9cfc7455e2e50eb1b74a62aee16cf204b69de1d9e695276f7.css integrity="sha256-GLXWUeJm5enPx0VeLlDrG3SmKu4WzyBLad4dnmlSdvc=" crossorigin=anonymous>
<script defer src=/flexsearch.min.js></script>
<script defer src=/zh.search.min.6d62265cf8d718194c34a2b87aeb2e156f76ba8273000bbbaddc12dd47783380.js integrity="sha256-bWImXPjXGBlMNKK4eusuFW92uoJzAAu7rdwS3Ud4M4A=" crossorigin=anonymous></script>
<script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script>
</head>
<body dir=ltr>
<input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control>
<main class="container flex">
<aside class=book-menu>
<div class=book-menu-content>
<nav>
<h2 class=book-brand>
<a class="flex align-center" href=/><img src=/j.png alt=Logo><span>老J的博客</span>
</a>
</h2>
<div class=book-search>
<input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/>
<div class="book-search-spinner hidden"></div>
<ul id=book-search-results></ul>
</div>
<ul>
<li>
<a href=/posts/>
文章
</a>
</li>
</ul>
<ul>
<li>
<span>我的项目</span>
<ul>
<li>
<a href=/docs/mywork/gcopy/>GCopy</a>
</li>
<li>
<a href=/docs/mywork/oauth2nsso/>OAuth2&SSO</a>
</li>
<li>
<a href=/docs/mywork/kubefinder/>KubeFinder</a>
</li>
</ul>
</li>
<li>
<a href=/docs/about/>关于</a>
<ul>
</ul>
</li>
</ul>
<ul>
<li>
<a href=https://www.cncf.io/ target=_blank rel=noopener>
CNCF
</a>
</li>
<li>
<a href=https://ebpf.io/ target=_blank rel=noopener>
eBPF
</a>
</li>
</ul>
<div class=book-menu-after>
<a href=https://www.rutron.net/ target=_blank>@如创科技</a><br>提供云计算支持
</div>
</nav>
<script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</div>
</aside>
<div class=book-page>
<header class=book-header>
<div class="flex align-center justify-between">
<label for=menu-control>
<img src=/svg/menu.svg class=book-icon alt=Menu>
</label>
<strong>Apisxi Ingress Controller 设计说明</strong>
<label for=toc-control>
<img src=/svg/toc.svg class=book-icon alt="Table of Contents">
</label>
</div>
<aside class="hidden clearfix">
<nav id=TableOfContents>
<ul>
<li><a href=#状态>状态</a></li>
<li><a href=#先决条件>先决条件</a></li>
<li><a href=#功能特性>功能特性</a>
<ul>
<li><a href=#apache-apisix-ingress-vs-kubernetes-nginx-ingress>Apache APISIX Ingress vs. Kubernetes Nginx Ingress</a></li>
</ul>
</li>
<li><a href=#设计原理>设计原理</a>
<ul>
<li><a href=#架构>架构</a></li>
<li><a href=#时序流程图>时序/流程图</a></li>
<li><a href=#结构转换>结构转换</a></li>
<li><a href=#规则比较>规则比较</a></li>
<li><a href=#服务发现>服务发现</a></li>
<li><a href=#annotation-实现>Annotation 实现</a></li>
</ul>
</li>
<li><a href=#apisixroute-介绍>ApisixRoute 介绍</a>
<ul>
<li><a href=#基于路径的路由规则>基于路径的路由规则</a></li>
<li><a href=#高级路由特性>高级路由特性</a></li>
<li><a href=#基于权重的流量切分>基于权重的流量切分</a></li>
<li><a href=#插件>插件</a></li>
<li><a href=#websocket-代理>Websocket 代理</a></li>
<li><a href=#tcp-路由>TCP 路由</a></li>
<li><a href=#udp-路由>UDP 路由</a></li>
</ul>
</li>
<li><a href=#apisixupstream-介绍>ApisixUpstream 介绍</a>
<ul>
<li><a href=#配置负载均衡>配置负载均衡</a></li>
<li><a href=#配置健康检查>配置健康检查</a></li>
<li><a href=#配置重试和超时>配置重试和超时</a></li>
<li><a href=#端口级别配置>端口级别配置</a></li>
</ul>
</li>
<li><a href=#用户故事>用户故事</a></li>
</ul>
</nav>
</aside>
</header>
<article class=markdown>
<h1>
<a href=/posts/2204/apisix-ingress-controller-design/>Apisxi Ingress Controller 设计说明</a>
</h1>
<h5>2022-4-14</h5>
<div>
<a href=/categories/technology/>technology</a>
</div>
<div>
<a href=/tags/apisix/>apisix</a>,
<a href=/tags/kubernetes/>kubernetes</a>
</div>
<p>Apache APISIX - 专门为 kubernetes 研发的入口控制器。</p>
<h2 id=状态>
状态
<a class=anchor href=#%e7%8a%b6%e6%80%81>#</a>
</h2>
<p>该项目目前是 general availability 级别</p>
<h2 id=先决条件>
先决条件
<a class=anchor href=#%e5%85%88%e5%86%b3%e6%9d%a1%e4%bb%b6>#</a>
</h2>
<p>apisix-ingress-controller 要求 kubernetes 版本 1.16+. 因为使用了 CustomResourceDefinition v1 stable 版本的 API.
从 1.0.0 版本开始，APISIX-ingress-controller 要求 Apache APISIX 版本 2.7+.</p>
<h2 id=功能特性>
功能特性
<a class=anchor href=#%e5%8a%9f%e8%83%bd%e7%89%b9%e6%80%a7>#</a>
</h2>
<ul>
<li>使用 Custom Resource Definitions(CRDs) 对 Apache APISIX 进行声明式配置，使用 kubernetes yaml 结构最小化学习成本。</li>
<li>Yaml 配置热加载</li>
<li>支持原生 Kubernetes Ingress (v1 和 v1beta1) 资源</li>
<li>Kubernetes endpoint 自动注册到 Apache APISIX 上游节点</li>
<li>支持基于 POD（上游节点） 的负载均衡</li>
<li>开箱支持上游节点健康检查</li>
<li>扩展插件支持热配置并且立即生效</li>
<li>支持路由的 SSL 和 mTLS</li>
<li>支持流量切割和金丝雀发布</li>
<li>支持 TCP 4层代理</li>
<li>Ingress 控制器本身也是一个可插拔的热加载组件</li>
<li>多集群配置分发</li>
</ul>
<p>
<a href="https://docs.google.com/spreadsheets/d/191WWNpjJ2za6-nbG4ZoUMXMpUK8KlCIosvQB0f-oq3k/edit#gid=907731238">这里有一份在线竞品分析表格</a></p>
<h3 id=apache-apisix-ingress-vs-kubernetes-nginx-ingress>
Apache APISIX Ingress vs. Kubernetes Nginx Ingress
<a class=anchor href=#apache-apisix-ingress-vs-kubernetes-nginx-ingress>#</a>
</h3>
<ul>
<li>yaml 配置热加载</li>
<li>更方便的金丝雀发布</li>
<li>配置验证，安全可靠</li>
<li>丰富的插件和生态,
<a href=https://github.com/apache/apisix/tree/master/docs/en/latest/plugins>插件列表</a></li>
<li>支持 APISIX 自定义资源和原生 kubernetes ingress 资源</li>
<li>更活跃的社区</li>
</ul>
<h2 id=设计原理>
设计原理
<a class=anchor href=#%e8%ae%be%e8%ae%a1%e5%8e%9f%e7%90%86>#</a>
</h2>
<h3 id=架构>
架构
<a class=anchor href=#%e6%9e%b6%e6%9e%84>#</a>
</h3>
<p>apisix-ingress-controller 需要的所有配置都是通过 Kubernetes CRDs (Custom Resource Definitions) 定义的。支持在 Apache APISIX 中配置插件、上游的服务注册发现机制、负载均衡等。<br>
apisix-ingress-controller 是 Apache APISIX 的控制面组件. 当前服务于 Kubernetes 集群。 未来, 计划分离出子模块以适配更多的部署模式，比如虚拟机集群部署。</p>
<p>整体架构图如下：</p>
<p>
<img src=/posts/2204/apisix-ingress-controller-design/arch.png alt=architecture></p>
<p>这是一张内部架构图：</p>
<p>
<img src=/posts/2204/apisix-ingress-controller-design/internal-arch.png alt=internal-arch></p>
<h3 id=时序流程图>
时序/流程图
<a class=anchor href=#%e6%97%b6%e5%ba%8f%e6%b5%81%e7%a8%8b%e5%9b%be>#</a>
</h3>
<p>apisix-ingress-controller 负责和 Kubernetes Apiserver 交互, 申请可访问资源权限（RBAC），监控变化，在 Ingress 控制器中实现对象转换，比较变化，然后同步到 Apache APISIX。</p>
<p>
<img src=/posts/2204/apisix-ingress-controller-design/flow.png alt=flow></p>
<p>这是一张流程图，介绍了ApisixRoute和其他CRD在同步过程中的主要逻辑</p>
<p>
<img src=/posts/2204/apisix-ingress-controller-design/sync-logic-controller.png alt=sync-logic-controller></p>
<h3 id=结构转换>
结构转换
<a class=anchor href=#%e7%bb%93%e6%9e%84%e8%bd%ac%e6%8d%a2>#</a>
</h3>
<p>apisix-ingress-controller 给 CRDs 提供了外部配置方法。它旨在务于需要日常操作和维护的运维人员，他们需要经常处理大量路由配置，希望在一个配置文件中处理所有相关的服务，同时还希望能具备便捷和易于理解的管理能力。但是，Apache APISIX 则是从网关的角度设计的，并且所有的路由都是独立的。这就导致了两者在数据结构上存在差异。一个注重批量定义，一个注重离散实现。<br>
考虑到不同人群的使用习惯，CRDs 的数据结构借鉴了 Kubernetes Ingress 的数据结构，数据结构基本一致。
关于这两者的差别，请看下面这张图：</p>
<p>
<img src=/posts/2204/apisix-ingress-controller-design/struct-compare.png alt=struct-compare></p>
<p>可以看到，它们是多对多的关系。因此，apisix-ingress-controller 必须对 CRD 做一些转换，以适应不同的网关。</p>
<h3 id=规则比较>
规则比较
<a class=anchor href=#%e8%a7%84%e5%88%99%e6%af%94%e8%be%83>#</a>
</h3>
<p>seven 模块内部保存了内存数据结构，目前与Apache APISIX资源对象非常相似。当 Kubernetes 资源对象有新变化时，seven 会比较内存对象，并根据比较结果进行增量更新。<br>
目前的比较规则是根据route/service/upstream资源对象的分组，分别进行比较，发现差异后做出相应的广播通知。</p>
<p>
<img src=/posts/2204/apisix-ingress-controller-design/diff-rules.png alt=diff-rules></p>
<h3 id=服务发现>
服务发现
<a class=anchor href=#%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0>#</a>
</h3>
<p>根据 <code>ApisixUpstream</code> 中定义的 <code>namespace</code> <code>name</code> <code>port</code> 字段，apisix-ingress-controller 会在 Apache APISIX Upstream 中注册 处于 running 状态的 endpoints 节点，并且根据 kubernetes endpoints 状态进行实时同步。<br>
基于服务发现，apisix-ingress-controller 可以直接访问后端 pod，绕过 Kubernetes Service，可以实现自定义的负载均衡策略。</p>
<h3 id=annotation-实现>
Annotation 实现
<a class=anchor href=#annotation-%e5%ae%9e%e7%8e%b0>#</a>
</h3>
<p>不像 Kubernetes Nginx Ingress Controller，apisix-ingress-controller 的 annotation 实现是基于 Apache APISIX 的插件机制的。<br>
比如，可以通过在<code>ApisixRoute</code>资源对象中设置<code>k8s.apisix.apache.org/whitelist-source-range</code>annotation来配置白名单。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>apisix.apache.org/v2beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>ApisixRoute<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>annotations</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>k8s.apisix.apache.org/whitelist-source-range</span>:<span style=color:#bbb> </span><span style=color:#099>1.2.3.4</span>,<span style=color:#099>2.2.0.0</span>/16<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>httpserver-route<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></code></pre></div><p>黑/白名单功能是通过
<a href=https://github.com/apache/apisix/blob/master/docs/en/latest/plugins/ip-restriction.md>ip-restriction</a>插件来实现的。<br>
为方便的定义一些常用的配置，未来会有更多的 annotation 实现，比如CORS。</p>
<h2 id=apisixroute-介绍>
ApisixRoute 介绍
<a class=anchor href=#apisixroute-%e4%bb%8b%e7%bb%8d>#</a>
</h2>
<p>ApisixRoute 是一个 CRD 资源，它关注如何将流量发送到后端，它有很多 APISIX 支持的特性。相比 Ingress，功能实现的更原生，语意更强。</p>
<h3 id=基于路径的路由规则>
基于路径的路由规则
<a class=anchor href=#%e5%9f%ba%e4%ba%8e%e8%b7%af%e5%be%84%e7%9a%84%e8%b7%af%e7%94%b1%e8%a7%84%e5%88%99>#</a>
</h3>
<p>URI 路径总是用于拆分流量，比如访问 foo.com 的请求， 含有 /foo 前缀请求路由到 foo 服务，访问 /bar 的请求要路由到 bar 服务。以 ApisixRoute 方式配置应该是这样的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>apisix.apache.org/v2beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>ApisixRoute<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>foo-bar-route<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>http</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>foo<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>match</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>hosts</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- foo.com<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>paths</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- <span style=color:#d14>&#34;/foo*&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>backends</span>:<span style=color:#bbb>
</span><span style=color:#bbb>     </span>- <span style=color:navy>serviceName</span>:<span style=color:#bbb> </span>foo<span style=color:#bbb>
</span><span style=color:#bbb>       </span><span style=color:navy>servicePort</span>:<span style=color:#bbb> </span><span style=color:#099>80</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>bar<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>match</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>paths</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:#d14>&#34;/bar&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>backends</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- <span style=color:navy>serviceName</span>:<span style=color:#bbb> </span>bar<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>servicePort</span>:<span style=color:#bbb> </span><span style=color:#099>80</span><span style=color:#bbb>
</span></code></pre></div><p>有<code>prefix</code>和<code>exact</code>两种路径类型可用 默认<code>exact</code>，当需要前缀匹配的时候，就在路径后加 * 比如 /id/* 能匹配所有带 /id/ 前缀的请求。</p>
<h3 id=高级路由特性>
高级路由特性
<a class=anchor href=#%e9%ab%98%e7%ba%a7%e8%b7%af%e7%94%b1%e7%89%b9%e6%80%a7>#</a>
</h3>
<p>基于路径的路由是最普遍的，但这并不够， 再试一下其他路由方式，比如 <code>methods</code> 和 <code>exprs</code></p>
<p><code>methods</code> 通过 HTTP 动作来切分流量，下面例子会把所有 GET 请求路由到 foo 服务（kubernetes service）</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>apisix.apache.org/v2beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>ApisixRoute<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>method-route<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>http</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>method<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>match</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>paths</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span>- /<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>methods</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span>- GET<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>backends</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:navy>serviceName</span>:<span style=color:#bbb> </span>foo<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:navy>servicePort</span>:<span style=color:#bbb> </span><span style=color:#099>80</span><span style=color:#bbb>
</span></code></pre></div><p><code>exprs</code>允许用户使用 HTTP 中的任意字符串来配置匹配条件，例如query、HTTP Header、Cookie。它可以配置多个表达式，而这些表达式又由主题(subject)、运算符(operator)和值/集合(value/set)组成。比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>apisix.apache.org/v2beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>ApisixRoute<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>method-route<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>http</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>method<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>match</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>paths</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span>- /<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>exprs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span>- <span style=color:navy>subject</span>:<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:navy>scope</span>:<span style=color:#bbb> </span>Query<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>id<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:navy>op</span>:<span style=color:#bbb> </span>Equal<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:navy>value</span>:<span style=color:#bbb> </span><span style=color:#d14>&#34;2143&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>backends</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:navy>serviceName</span>:<span style=color:#bbb> </span>foo<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:navy>servicePort</span>:<span style=color:#bbb> </span><span style=color:#099>80</span><span style=color:#bbb>
</span></code></pre></div><p>上面是绝对匹配，匹配所有请求的 query 字符串中 id 的值必须等于 2143。</p>
<h4 id=服务解析粒度>
服务解析粒度
<a class=anchor href=#%e6%9c%8d%e5%8a%a1%e8%a7%a3%e6%9e%90%e7%b2%92%e5%ba%a6>#</a>
</h4>
<p>默认，apisix-ingress-controller 会监听 service 的引用，所以最新的 endpoints 列表会被更新到 Apache APISIX。同样 apisix-ingress-controller 也可以直接使用 service 自身的 clusterIP。如果这正是你想要的，配置 <code>resolveGranularity: service</code>(默认<code>endpoint</code>). 如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>apisix.apache.org/v2beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>ApisixRoute<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>method-route<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>http</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>method<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>match</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>paths</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span>- /*<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>methods</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span>- GET<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>backends</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:navy>serviceName</span>:<span style=color:#bbb> </span>foo<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:navy>servicePort</span>:<span style=color:#bbb> </span><span style=color:#099>80</span><span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:navy>resolveGranularity</span>:<span style=color:#bbb> </span>service<span style=color:#bbb>
</span></code></pre></div><h3 id=基于权重的流量切分>
基于权重的流量切分
<a class=anchor href=#%e5%9f%ba%e4%ba%8e%e6%9d%83%e9%87%8d%e7%9a%84%e6%b5%81%e9%87%8f%e5%88%87%e5%88%86>#</a>
</h3>
<p>这是 APISIX Ingress Controller 一个非常棒的特性。一个路由规则中可以指定多个后端，当多个后端共存时，将应用基于权重的流量拆分（实际上是使用Apache APISIX中的流量拆分
<a href=https://apisix.apache.org/zh/docs/apisix/plugins/traffic-split/>traffic-split</a> 插件）您可以为每个后端指定权重，默认权重为 100。比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>apisix.apache.org/v2beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>ApisixRoute<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>method-route<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>http</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>method<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>match</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>paths</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span>- /*<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>methods</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span>- GET<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>exprs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span>- <span style=color:navy>subject</span>:<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:navy>scope</span>:<span style=color:#bbb> </span>Header<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>User-Agent<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:navy>op</span>:<span style=color:#bbb> </span>RegexMatch<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:navy>value</span>:<span style=color:#bbb> </span><span style=color:#d14>&#34;.*Chrome.*&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>backends</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:navy>serviceName</span>:<span style=color:#bbb> </span>foo<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:navy>servicePort</span>:<span style=color:#bbb> </span><span style=color:#099>80</span><span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:navy>weight</span>:<span style=color:#bbb> </span><span style=color:#099>100</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:navy>serviceName</span>:<span style=color:#bbb> </span>bar<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:navy>servicePort</span>:<span style=color:#bbb> </span><span style=color:#099>81</span><span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:navy>weight</span>:<span style=color:#bbb> </span><span style=color:#099>50</span><span style=color:#bbb>
</span></code></pre></div><p>上面有一个路由规则（1.所有<code>GET /*</code>请求 2.Header中有匹配 <code>User-Agent: .*Chrome.*</code> 的条目）它有两个后端服务 foo、bar，权重是100：50，意味着有2/3的流量会进入 foo，有1/3的流量会进入bar。</p>
<h3 id=插件>
插件
<a class=anchor href=#%e6%8f%92%e4%bb%b6>#</a>
</h3>
<p>Apache APISIX 提供了 40 多个插件，可以在 APIsixRoute 中使用。所有配置项的名称与 APISIX 中的相同。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>apisix.apache.org/v2beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>ApisixRoute<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>httpbin-route<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>http</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>httpbin<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>match</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>hosts</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- local.httpbin.org<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>paths</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span>- /*<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>backends</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:navy>serviceName</span>:<span style=color:#bbb> </span>foo<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:navy>servicePort</span>:<span style=color:#bbb> </span><span style=color:#099>80</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>plugins</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>cors<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:navy>enable</span>:<span style=color:#bbb> </span><span style=color:#000;font-weight:700>true</span><span style=color:#bbb>
</span></code></pre></div><p>为到 local.httpbin.org 的请求都配置了 Cors 插件</p>
<h3 id=websocket-代理>
Websocket 代理
<a class=anchor href=#websocket-%e4%bb%a3%e7%90%86>#</a>
</h3>
<p>创建一个 route，配置特定的 websocket 字段，就可以代理 websocket 服务。比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>apisix.apache.org/v2beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>ApisixRoute<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>ws-route<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>http</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>websocket<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>match</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>hosts</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span>- ws.foo.org<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>paths</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span>- /*<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>backends</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:navy>serviceName</span>:<span style=color:#bbb> </span>websocket-server<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:navy>servicePort</span>:<span style=color:#bbb> </span><span style=color:#099>8080</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>websocket</span>:<span style=color:#bbb> </span><span style=color:#000;font-weight:700>true</span><span style=color:#bbb>
</span></code></pre></div><h3 id=tcp-路由>
TCP 路由
<a class=anchor href=#tcp-%e8%b7%af%e7%94%b1>#</a>
</h3>
<p>apisix-ingress-controller 支持基于端口的 tcp 路由</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>apisix.apache.org/v2beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>ApisixRoute<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>tcp-route<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>stream</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>tcp-route-rule1<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>match</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>ingressPort</span>:<span style=color:#bbb> </span><span style=color:#099>9100</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>backend</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>serviceName</span>:<span style=color:#bbb> </span>tcp-server<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>servicePort</span>:<span style=color:#bbb> </span><span style=color:#099>8080</span><span style=color:#bbb>
</span></code></pre></div><p>进入 apisix-ingress-controller 9100 端口的 TCP 流量会路由到后端 tcp-server 服务。</p>
<p><strong>注意：</strong> APISIX不支持动态监听，所以需要在APISIX
<a href=https://github.com/apache/apisix/blob/master/conf/config-default.yaml#L111>配置文件</a>中预先定义9100端口。</p>
<h3 id=udp-路由>
UDP 路由
<a class=anchor href=#udp-%e8%b7%af%e7%94%b1>#</a>
</h3>
<p>apisix-ingress-controller 支持基于端口的 udp 路由</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>apisix.apache.org/v2beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>ApisixRoute<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>udp-route<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>stream</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>udp-route-rule1<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>protocol</span>:<span style=color:#bbb> </span>UDP<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>match</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>ingressPort</span>:<span style=color:#bbb> </span><span style=color:#099>9200</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>backend</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>serviceName</span>:<span style=color:#bbb> </span>udp-server<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>servicePort</span>:<span style=color:#bbb> </span><span style=color:#099>53</span><span style=color:#bbb>
</span></code></pre></div><p>进入 apisix-ingress-controller 9200 端口的 TCP 流量会路由到后端 udp-server 服务。</p>
<p><strong>注意：</strong> APISIX不支持动态监听，所以需要在APISIX
<a href=https://github.com/apache/apisix/blob/master/conf/config-default.yaml#L111>配置文件</a>中预先定义9200端口。</p>
<h2 id=apisixupstream-介绍>
ApisixUpstream 介绍
<a class=anchor href=#apisixupstream-%e4%bb%8b%e7%bb%8d>#</a>
</h2>
<p>ApisixUpstream 是 kubernetes service 的装饰器。它设计成与其关联的 kubernetes service 的名字一致，将其变得更加强大，使该 kubernetes service 能够配置负载均衡策略、健康检查、重试、超时参数等。<br>
通过 ApisixUpstream 和 kubernetes service，apisix-ingress-controller 会生成 APISIX Upstream(s).</p>
<h3 id=配置负载均衡>
配置负载均衡
<a class=anchor href=#%e9%85%8d%e7%bd%ae%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1>#</a>
</h3>
<p>需要适当的负载均衡算法来合理地分散 Kubernetes Service 的请求</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>apisix.apache.org/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>ApisixUpstream<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>httpbin<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>loadbalancer</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>type</span>:<span style=color:#bbb> </span>ewma<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#555>---</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>httpbin<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>selector</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>app</span>:<span style=color:#bbb> </span>httpbin<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>ports</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>http<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>port</span>:<span style=color:#bbb> </span><span style=color:#099>80</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>targetPort</span>:<span style=color:#bbb> </span><span style=color:#099>8080</span><span style=color:#bbb>
</span></code></pre></div><p>上面这个例子给 httpbin 服务配置了 ewma 负载均衡算法。有时候可能会需要会话保持，你可以配置一致性哈希负载均衡算法</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>apisix.apache.org/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>ApisixUpstream<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>httpbin<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>loadbalancer</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>type</span>:<span style=color:#bbb> </span>chash<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>hashOn</span>:<span style=color:#bbb> </span>header<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>key</span>:<span style=color:#bbb> </span><span style=color:#d14>&#34;user-agent&#34;</span><span style=color:#bbb>
</span></code></pre></div><p>这样 apisix 就会根据 user-agent header 来分发流量。</p>
<h3 id=配置健康检查>
配置健康检查
<a class=anchor href=#%e9%85%8d%e7%bd%ae%e5%81%a5%e5%ba%b7%e6%a3%80%e6%9f%a5>#</a>
</h3>
<p>尽管 kubelet 已经提供了检测 pod 健康的探针机制。你可能还需要更加丰富的健康检查机制，比如被动健康检查机制。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>apisix.apache.org/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>ApisixUpstream<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>httpbin<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>healthCheck</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>passive</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>unhealthy</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>httpCodes</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span>- <span style=color:#099>500</span><span style=color:#bbb>
</span><span style=color:#bbb>          </span>- <span style=color:#099>502</span><span style=color:#bbb>
</span><span style=color:#bbb>          </span>- <span style=color:#099>503</span><span style=color:#bbb>
</span><span style=color:#bbb>          </span>- <span style=color:#099>504</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>httpFailures</span>:<span style=color:#bbb> </span><span style=color:#099>3</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>timeout</span>:<span style=color:#bbb> </span>5s<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>active</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>type</span>:<span style=color:#bbb> </span>http<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>httpPath</span>:<span style=color:#bbb> </span>/healthz<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>timeout</span>:<span style=color:#bbb> </span>5s<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>host</span>:<span style=color:#bbb> </span>www.foo.com<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:navy>healthy</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>successes</span>:<span style=color:#bbb> </span><span style=color:#099>3</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>interval</span>:<span style=color:#bbb> </span>2s<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:navy>httpCodes</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span>- <span style=color:#099>200</span><span style=color:#bbb>
</span><span style=color:#bbb>          </span>- <span style=color:#099>206</span><span style=color:#bbb>
</span></code></pre></div><p>上面的yaml片段定义了被动健康检查器来检查endpoints的健康状况。一旦连续三次请求的响应状态码是错误（500 502 503 504 中的一个），这个endpoint就会被标记成不健康并不会再给它分配流量了，直到它再次健康。<br>
所以，主动健康检查器就出现了。endpoint 可能掉线一段时间又回复健康，主动健康检查器主动探测这些不健康的endpoints，一旦满足健康条件就将其恢复为健康（条件：连续三次请求响应状态码为200或206）</p>
<blockquote>
<p>注意：主动健康检查器在某种程度上与 liveness/readiness 探针重复，但如果使用被动健康检查机制，则它是必需的。因此，一旦您使用了 ApisixUpstream 中的健康检查功能，主动健康检查器是强制性的。</p>
</blockquote>
<h3 id=配置重试和超时>
配置重试和超时
<a class=anchor href=#%e9%85%8d%e7%bd%ae%e9%87%8d%e8%af%95%e5%92%8c%e8%b6%85%e6%97%b6>#</a>
</h3>
<p>当请求出现错误，比如网络问题或者服务不可用当时候，你可能想重试请求。默认重试次数是1，通过定义<code>retries</code>字段可以改变这个值。<br>
下面这个例子将<code>retries</code>定义为3，表明会对kubernetes service/httpbin的endpoints最多请求3次。</p>
<blockquote>
<p>注意：只有在尚未向客户端响应任何内容的情况下，才有可能将请求重试传递到下一个端点。也就是说，如果在传输响应的过程中发生错误或超时，就不会重试了。</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>apisix.apache.org/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>ApisixUpstream<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>httpbin<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>retries</span>:<span style=color:#bbb> </span><span style=color:#099>3</span><span style=color:#bbb>
</span></code></pre></div><p>默认，connect、send 和 read 的超时时间是60s，这可能对有些应用不合适，修改<code>timeout</code>字段来改变默认值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>apisix.apache.org/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>ApisixUpstream<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>httpbin<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>timeout</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>connect</span>:<span style=color:#bbb> </span>5s<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>read</span>:<span style=color:#bbb> </span>10s<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>send</span>:<span style=color:#bbb> </span>10s<span style=color:#bbb>
</span></code></pre></div><p>上面例子将connect、read 和 send 分别设置为 5s、10s、10s。</p>
<h3 id=端口级别配置>
端口级别配置
<a class=anchor href=#%e7%ab%af%e5%8f%a3%e7%ba%a7%e5%88%ab%e9%85%8d%e7%bd%ae>#</a>
</h3>
<p>有时，单个 kubernetes service 可能会暴露多个端口，这些端口提供不同的功能并且需要不同的上游配置。在这种情况下，您可以为单个端口创建配置。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>apisix.apache.org/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>ApisixUpstream<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>foo<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>loadbalancer</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>type</span>:<span style=color:#bbb> </span>roundrobin<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>portLevelSettings</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:navy>port</span>:<span style=color:#bbb> </span><span style=color:#099>7000</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>scheme</span>:<span style=color:#bbb> </span>http<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:navy>port</span>:<span style=color:#bbb> </span><span style=color:#099>7001</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>scheme</span>:<span style=color:#bbb> </span>grpc<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#555>---</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>foo<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>selector</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>app</span>:<span style=color:#bbb> </span>foo<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>portLevelSettings</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>http<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>port</span>:<span style=color:#bbb> </span><span style=color:#099>7000</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>targetPort</span>:<span style=color:#bbb> </span><span style=color:#099>7000</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>grpc<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>port</span>:<span style=color:#bbb> </span><span style=color:#099>7001</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>targetPort</span>:<span style=color:#bbb> </span><span style=color:#099>7001</span><span style=color:#bbb>
</span></code></pre></div><p>foo 服务暴露的两个端口，一个使用http协议，另一个使用grpc协议。同时，ApisixUpstream/foo 为7000端口配置http协议，为7001端口配置grpc协议（所有端口都是service端口），两个端口都共享使用同一个负载均衡算法。<br>
如果服务仅公开一个端口，则 PortLevelSettings 不是必需的，但在定义多个端口时很有用。</p>
<h2 id=用户故事>
用户故事
<a class=anchor href=#%e7%94%a8%e6%88%b7%e6%95%85%e4%ba%8b>#</a>
</h2>
<p>
<a href=https://mp.weixin.qq.com/s/bmm2ibk2V7-XYneLo9XAPQ>思必驰：为什么我们重新写了一个 k8s ingress controller？</a><br>
<a href=https://www.upyun.com/opentalk/448.html>腾讯云：为什么选择 apisix 实现 kubernetes ingress controller</a></p>
</article>
<footer class=book-footer>
<div class="flex flex-wrap justify-between">
</div>
<script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){if(window.getSelection().toString())return;a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>
</footer>
<div class=book-comments><link rel=stylesheet href=https://unpkg.com/gitalk/dist/gitalk.css>
<script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script>
<div id=gitalk-container></div>
<script type=text/javascript>const gitalk=new Gitalk({clientID:'53c7373e7b1554a4abc3',clientSecret:'7c9dcef80ea6bde5d8695d1ab94bcef87063fb3b',repo:'llaoj.github.io',owner:'llaoj',admin:['llaoj'],id:location.pathname,distractionFreeMode:!1});gitalk.render('gitalk-container')</script></div>
<label for=menu-control class="hidden book-menu-overlay"></label>
</div>
<aside class=book-toc>
<div class=book-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#状态>状态</a></li>
<li><a href=#先决条件>先决条件</a></li>
<li><a href=#功能特性>功能特性</a>
<ul>
<li><a href=#apache-apisix-ingress-vs-kubernetes-nginx-ingress>Apache APISIX Ingress vs. Kubernetes Nginx Ingress</a></li>
</ul>
</li>
<li><a href=#设计原理>设计原理</a>
<ul>
<li><a href=#架构>架构</a></li>
<li><a href=#时序流程图>时序/流程图</a></li>
<li><a href=#结构转换>结构转换</a></li>
<li><a href=#规则比较>规则比较</a></li>
<li><a href=#服务发现>服务发现</a></li>
<li><a href=#annotation-实现>Annotation 实现</a></li>
</ul>
</li>
<li><a href=#apisixroute-介绍>ApisixRoute 介绍</a>
<ul>
<li><a href=#基于路径的路由规则>基于路径的路由规则</a></li>
<li><a href=#高级路由特性>高级路由特性</a></li>
<li><a href=#基于权重的流量切分>基于权重的流量切分</a></li>
<li><a href=#插件>插件</a></li>
<li><a href=#websocket-代理>Websocket 代理</a></li>
<li><a href=#tcp-路由>TCP 路由</a></li>
<li><a href=#udp-路由>UDP 路由</a></li>
</ul>
</li>
<li><a href=#apisixupstream-介绍>ApisixUpstream 介绍</a>
<ul>
<li><a href=#配置负载均衡>配置负载均衡</a></li>
<li><a href=#配置健康检查>配置健康检查</a></li>
<li><a href=#配置重试和超时>配置重试和超时</a></li>
<li><a href=#端口级别配置>端口级别配置</a></li>
</ul>
</li>
<li><a href=#用户故事>用户故事</a></li>
</ul>
</nav>
</div>
</aside>
</main>
</body>
</html>