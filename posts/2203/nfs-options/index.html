<!doctype html><html lang=zh dir=ltr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="load average 过高 mount nfs 问题处理">
<meta name=theme-color content="#FFFFFF">
<meta name=color-scheme content="light dark"><meta property="og:title" content="load average 过高, mount nfs 问题处理">
<meta property="og:description" content="load average 过高 mount nfs 问题处理">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.llaoj.cn/posts/2203/nfs-options/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-03-14T00:00:00+00:00">
<meta property="article:modified_time" content="2022-03-14T00:00:00+00:00">
<title>load average 过高, mount nfs 问题处理 | 老J的博客</title>
<link rel=manifest href=/manifest.json>
<link rel=icon href=/favicon.png type=image/x-icon>
<link rel=stylesheet href=/book.min.18b5d651e266e5e9cfc7455e2e50eb1b74a62aee16cf204b69de1d9e695276f7.css integrity="sha256-GLXWUeJm5enPx0VeLlDrG3SmKu4WzyBLad4dnmlSdvc=" crossorigin=anonymous>
<script defer src=/flexsearch.min.js></script>
<script defer src=/zh.search.min.11c819f035f42e5353e942007ed2c14ea2ed8dae58e2791b4bd2686764cb892d.js integrity="sha256-EcgZ8DX0LlNT6UIAftLBTqLtja5Y4nkbS9JoZ2TLiS0=" crossorigin=anonymous></script>
<script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script>
<script>var _hmt=_hmt||[];(function(){var a=document.createElement("script"),b;a.src="https://hm.baidu.com/hm.js?7f5ad4632a1c2df3cd8e1199a7aaf48a",b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script>
</head>
<body dir=ltr>
<input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control>
<main class="container flex">
<aside class=book-menu>
<div class=book-menu-content>
<nav>
<h2 class=book-brand>
<a class="flex align-center" href=/><img src=/j.png alt=Logo><span>老J的博客</span>
</a>
</h2>
<div class=book-search>
<input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/>
<div class="book-search-spinner hidden"></div>
<ul id=book-search-results></ul>
</div>
<ul>
<li>
<a href=/posts/>
文章
</a>
</li>
</ul>
<ul>
<li>
<a href=/docs/oauth2nsso/>OAuth2&SSO</a>
<ul>
<li>
<a href=/docs/oauth2nsso/configuration/>配置</a>
</li>
<li>
<a href=/docs/oauth2nsso/apis/>API列表</a>
</li>
<li>
<a href=/docs/oauth2nsso/deploy/>部署</a>
</li>
<li>
<a href=/docs/oauth2nsso/note/>说明</a>
</li>
<li>
<a href=/docs/oauth2nsso/demo/>示例</a>
</li>
<li>
<a href=/docs/oauth2nsso/for-client/>接入指引</a>
</li>
</ul>
</li>
<li>
<a href=/docs/about/>关于</a>
<ul>
</ul>
</li>
</ul>
<ul>
<li>
<a href=https://www.cncf.io/ target=_blank rel=noopener>
CNCF
</a>
</li>
<li>
<a href=https://ebpf.io/ target=_blank rel=noopener>
eBPF
</a>
</li>
</ul>
<div class=book-menu-after>
<a href=https://www.rutron.net/ target=_blank>@如创科技</a><br>提供云计算支持
</div>
</nav>
<script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</div>
</aside>
<div class=book-page>
<header class=book-header>
<div class="flex align-center justify-between">
<label for=menu-control>
<img src=/svg/menu.svg class=book-icon alt=Menu>
</label>
<strong>load average 过高, mount nfs 问题处理</strong>
<label for=toc-control>
<img src=/svg/toc.svg class=book-icon alt="Table of Contents">
</label>
</div>
<aside class="hidden clearfix">
<nav id=TableOfContents>
<ul>
<li><a href=#发现的问题现象>发现的问题/现象</a>
<ul>
<li><a href=#uptime-显示-load-average-都在70><code>uptime</code> 显示 load average 都在70+</a></li>
<li><a href=#ps--ef-执行到某一个进程就卡住了><code>ps -ef</code> 执行到某一个进程就卡住了</a></li>
<li><a href=#无法执行-umount-卸载>无法执行 umount 卸载</a></li>
</ul>
</li>
<li><a href=#继续分析>继续分析</a>
<ul>
<li><a href=#网络原因导致某连接断开-该连接进入持续的等待中>网络原因导致某连接断开, 该连接进入持续的等待中</a></li>
<li><a href=#官方不建议使用-nfs-作为-prometheus-后端存储>官方不建议使用 nfs 作为 prometheus 后端存储</a></li>
</ul>
</li>
</ul>
</nav>
</aside>
</header>
<article class=markdown>
<h1>
<a href=/posts/2203/nfs-options/>load average 过高, mount nfs 问题处理</a>
</h1>
<h5>2022-3-14</h5>
<div>
<a href=/categories/technology/>technology</a>
</div>
<div>
<a href=/tags/nfs/>nfs</a>,
<a href=/tags/kubernetes/>kubernetes</a>
</div>
<p>周末, 有一台服务器告警: 系统负载过高, 最高的时候都已经到 100 +, 以下是排查&处理的具体过程.</p>
<h2 id=发现的问题现象>
发现的问题/现象
<a class=anchor href=#%e5%8f%91%e7%8e%b0%e7%9a%84%e9%97%ae%e9%a2%98%e7%8e%b0%e8%b1%a1>#</a>
</h2>
<h3 id=uptime-显示-load-average-都在70>
<code>uptime</code> 显示 load average 都在70+
<a class=anchor href=#uptime-%e6%98%be%e7%a4%ba-load-average-%e9%83%bd%e5%9c%a870>#</a>
</h3>
<p>因为服务器是40核心, 原则上负载40是满负荷, 现在明显存在大量等待的任务. 继续往下分析进程, 看具体那个进程一直在堵塞.</p>
<h3 id=ps--ef-执行到某一个进程就卡住了>
<code>ps -ef</code> 执行到某一个进程就卡住了
<a class=anchor href=#ps--ef-%e6%89%a7%e8%a1%8c%e5%88%b0%e6%9f%90%e4%b8%80%e4%b8%aa%e8%bf%9b%e7%a8%8b%e5%b0%b1%e5%8d%a1%e4%bd%8f%e4%ba%86>#</a>
</h3>
<p>命令执行如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ ps -ef 
...
root  <span style=color:#099>40004</span>  <span style=color:#099>2912</span>  <span style=color:#099>0</span>  Mar08  ?  00:00:33  containerd-shim -namespace moby -workdir /data/docker/containerd/daemon/  
io.containerd.runtime.v1.linux/moby/&lt;container-hash&gt;
卡住了
</code></pre></div><p>根据命令中的 找到对应的 pod, 将其从当前节点移除. 移除之后, ps 命令以及其他系统命令可以成功执行. 被移除的 pod 分别是: 2个 prometheus、 1个 mysql.</p>
<h3 id=无法执行-umount-卸载>
无法执行 umount 卸载
<a class=anchor href=#%e6%97%a0%e6%b3%95%e6%89%a7%e8%a1%8c-umount-%e5%8d%b8%e8%bd%bd>#</a>
</h3>
<p>测试 mount 挂载正常, 但是 umount 失败, 解决办法:</p>
<ul>
<li>先强制 umount</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ umount  -f -l /mount-point

<span style=color:#998;font-style:italic># 命令解释</span>
$ umount <span style=color:#000;font-weight:700>[</span>options<span style=color:#000;font-weight:700>]</span> &lt;source&gt; | &lt;directory&gt;

Options:
-f   Force unmount <span style=color:#000;font-weight:700>(</span>in <span style=color:#000;font-weight:700>case</span> of an unreachable NFS system<span style=color:#000;font-weight:700>)</span>. <span style=color:#000;font-weight:700>(</span>Requires kernel 
2.1.116 or later.<span style=color:#000;font-weight:700>)</span>
-l   Lazy unmount. Detach the filesystem from the filesystem hierarchy now, 
and cleanup all references to the filesystem as soon as it is not busy 
anymore. <span style=color:#000;font-weight:700>(</span>Requires kernel 2.4.11 or later.<span style=color:#000;font-weight:700>)</span>
</code></pre></div><blockquote>
<p>
<a href=https://linux.die.net/man/8/umount>https://linux.die.net/man/8/umount</a></p>
</blockquote>
<ul>
<li>kill占用进程</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ fuser –m –v /mount-point
USER        PID  ACCESS COMMAND
/mount-point:
...
user1      <span style=color:#099>21691</span> .rce.  ls
...

<span style=color:#998;font-style:italic># 必须 -9</span>
$ <span style=color:#0086b3>kill</span> -9 <span style=color:#099>21691</span>
</code></pre></div><h2 id=继续分析>
继续分析
<a class=anchor href=#%e7%bb%a7%e7%bb%ad%e5%88%86%e6%9e%90>#</a>
</h2>
<p>通过阅读其他文档发现:</p>
<h3 id=网络原因导致某连接断开-该连接进入持续的等待中>
网络原因导致某连接断开, 该连接进入持续的等待中
<a class=anchor href=#%e7%bd%91%e7%bb%9c%e5%8e%9f%e5%9b%a0%e5%af%bc%e8%87%b4%e6%9f%90%e8%bf%9e%e6%8e%a5%e6%96%ad%e5%bc%80-%e8%af%a5%e8%bf%9e%e6%8e%a5%e8%bf%9b%e5%85%a5%e6%8c%81%e7%bb%ad%e7%9a%84%e7%ad%89%e5%be%85%e4%b8%ad>#</a>
</h3>
<p>这种情况会提高负载, 这里涉及一个 nfs 挂载参数, 通过 <code>mount | grep nfs</code> 看到 kubelet 默认的挂载配置如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ mount | grep nfs
10.***.***.6:/3PAR_d11_Node1_FPG/3PAR_d11_Node1_VFS/paas_share_FS/***/fz***c on 
/var/lib/kubelet/pods/c6c26172-1030-4dad-8611-102636803a58/volumes/kubernetes.io
~nfs/pvc-a7e8bf54-c787-44a4-94d5-b849ec2d24bb 
<span style=color:#0086b3>type</span> nfs4 
<span style=color:#000;font-weight:700>(</span>rw,relatime,vers<span style=color:#000;font-weight:700>=</span>4.0,rsize<span style=color:#000;font-weight:700>=</span>1048576,wsize<span style=color:#000;font-weight:700>=</span>1048576,
<span style=color:teal>namlen</span><span style=color:#000;font-weight:700>=</span>255,hard,proto<span style=color:#000;font-weight:700>=</span>tcp,timeo<span style=color:#000;font-weight:700>=</span>600,retrans<span style=color:#000;font-weight:700>=</span>2,
<span style=color:teal>sec</span><span style=color:#000;font-weight:700>=</span>sys,clientaddr<span style=color:#000;font-weight:700>=</span>10.***.***.140,local_lock<span style=color:#000;font-weight:700>=</span>none,
<span style=color:teal>addr</span><span style=color:#000;font-weight:700>=</span>10.***.***.6<span style=color:#000;font-weight:700>)</span>
...
</code></pre></div><p>括号中可以看到: rw, nfs4.0, hard, tcp 等配置信息, 简单说一下 mount 配置:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>mount -F nfs <span style=color:#000;font-weight:700>[</span>-o mount-options<span style=color:#000;font-weight:700>]</span> server:/directory /mount-point
<span style=color:#998;font-style:italic># 比如:</span>
mount -F nfs -o hard 192.168.0.10:/nfs /nfs
<span style=color:#998;font-style:italic># 同时使用多个参数使用逗号分隔：</span>
mount -t nfs -o <span style=color:teal>timeo</span><span style=color:#000;font-weight:700>=</span>3,udp,hard 192.168.0.30:/tmp /nfs
</code></pre></div><p><code>-o mount-options</code> 指定可以用来挂载 NFS 文件系统的挂载选项。有关常用的 mount 选项的列表，请参见
<a href=https://docs.oracle.com/cd/E19253-01/819-7062/6n91k1fr7/index.html#fsmount-66498>表 19–2</a><br>
<code>-o hard/soft</code> 如果服务器没有响应，有 hard 和 soft 两种处理方式, soft 选项表示返回了错误, hard 选项表示继续重试请求, 直到服务器响应为止. 缺省情况下使用 hard.</p>
<p>详细解释如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>soft / hard

Determines the recovery behavior of the NFS client after an NFS request times 
out. If neither option is specified (or if the hard option is specified), 
NFS requests are retried indefinitely. If the soft option is specified, 
then the NFS client fails an NFS request after retrans retransmissions 
have been sent, causing the NFS client to return an error to the calling 
application.  

NB: A so-called &#34;soft&#34; timeout can cause silent data corruption in certain 
cases. As such, use the soft option only when client responsiveness is more 
important than data integrity. Using NFS over TCP or increasing the value of 
the retrans option may mitigate some of the risks of using the soft option.  
</code></pre></div><blockquote>
<p>
<a href=https://linux.die.net/man/5/nfs>https://linux.die.net/man/5/nfs</a></p>
</blockquote>
<p>在某些情况下, soft 模式可能会导致静默数据损坏. 因此，仅当客户端响应比数据完整性更重要时才使用 soft. 考虑到 nfs 作为 kubernetes 持久卷使用的话, 数据完整性肯定是比较重要的, 所以还是沿用官方默认配置 hard. 并未做修改.</p>
<h3 id=官方不建议使用-nfs-作为-prometheus-后端存储>
官方不建议使用 nfs 作为 prometheus 后端存储
<a class=anchor href=#%e5%ae%98%e6%96%b9%e4%b8%8d%e5%bb%ba%e8%ae%ae%e4%bd%bf%e7%94%a8-nfs-%e4%bd%9c%e4%b8%ba-prometheus-%e5%90%8e%e7%ab%af%e5%ad%98%e5%82%a8>#</a>
</h3>
<p>阅读prometheus 文档发现:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>CAUTION:
Non-POSIX compliant filesystems are not supported for Prometheus&#39; local 
storage as unrecoverable corruptions may happen. NFS filesystems (including 
AWS&#39;s EFS) are not supported. NFS could be POSIX-compliant, but most 
implementations are not. It is strongly recommended to use a local filesystem 
for reliability.
</code></pre></div><blockquote>
<p>
<a href=https://prometheus.io/docs/prometheus/latest/storage/>https://prometheus.io/docs/prometheus/latest/storage/</a></p>
</blockquote>
<p>听人劝吃饱饭, 文档中建议用本地文件系统, 所以使用
<a href=https://github.com/rancher/local-path-provisioner>rancher/local-path-provisioner</a> 替换了 prometheus 原来的 nfs 后端存储.</p>
</article>
<footer class=book-footer>
<div class="flex flex-wrap justify-between">
</div>
<script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){if(window.getSelection().toString())return;a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>
</footer>
<div class=book-comments><link rel=stylesheet href=https://unpkg.com/gitalk/dist/gitalk.css>
<script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script>
<div id=gitalk-container></div>
<script type=text/javascript>const gitalk=new Gitalk({clientID:'53c7373e7b1554a4abc3',clientSecret:'7c9dcef80ea6bde5d8695d1ab94bcef87063fb3b',repo:'llaoj.github.io',owner:'llaoj',admin:['llaoj'],id:location.pathname,distractionFreeMode:!1});gitalk.render('gitalk-container')</script></div>
<label for=menu-control class="hidden book-menu-overlay"></label>
</div>
<aside class=book-toc>
<div class=book-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#发现的问题现象>发现的问题/现象</a>
<ul>
<li><a href=#uptime-显示-load-average-都在70><code>uptime</code> 显示 load average 都在70+</a></li>
<li><a href=#ps--ef-执行到某一个进程就卡住了><code>ps -ef</code> 执行到某一个进程就卡住了</a></li>
<li><a href=#无法执行-umount-卸载>无法执行 umount 卸载</a></li>
</ul>
</li>
<li><a href=#继续分析>继续分析</a>
<ul>
<li><a href=#网络原因导致某连接断开-该连接进入持续的等待中>网络原因导致某连接断开, 该连接进入持续的等待中</a></li>
<li><a href=#官方不建议使用-nfs-作为-prometheus-后端存储>官方不建议使用 nfs 作为 prometheus 后端存储</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
</main>
</body>
</html>