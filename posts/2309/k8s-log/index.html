<!doctype html><html lang=zh dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Kubernetes相关日志方案
  #


  目前的方案
  #

目前的方案简单概括来说是: fluentd(daemonset)+es+kibana. 使用fluentd在集群每个节点运行一个fluentd实例采集日志通过调用k8s接口为每个日志添加kubernetes和container相关的标签, 然后直接发送到es存储.

  痛点
  #


es集群的维护成本较高, 比如索引的管理和优化, 集群规模的维护等. 需要技术和经验的加持, 故障处理效率不高.
es日志需要多副本, 并对整个文档进行索引, 占用资源较多.
fluentd直接推送到es, 中间少了流量缓冲.(fluentd自带缓冲区,该问题可有所缓解).
fluentd配置复杂

下面的方案会针对当前的方案提出, 分析与当前方案的优劣比较:"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://blog.llaoj.cn/posts/2309/k8s-log/"><meta property="og:site_name" content="老J的博客"><meta property="og:title" content="老J的博客"><meta property="og:description" content=" Kubernetes相关日志方案 # 目前的方案 # 目前的方案简单概括来说是: fluentd(daemonset)+es+kibana. 使用fluentd在集群每个节点运行一个fluentd实例采集日志通过调用k8s接口为每个日志添加kubernetes和container相关的标签, 然后直接发送到es存储.
痛点 # es集群的维护成本较高, 比如索引的管理和优化, 集群规模的维护等. 需要技术和经验的加持, 故障处理效率不高. es日志需要多副本, 并对整个文档进行索引, 占用资源较多. fluentd直接推送到es, 中间少了流量缓冲.(fluentd自带缓冲区,该问题可有所缓解). fluentd配置复杂 下面的方案会针对当前的方案提出, 分析与当前方案的优劣比较:"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><title>Index | 老J的博客</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://blog.llaoj.cn/posts/2309/k8s-log/><link rel=stylesheet href=/book.min.64c4ccf49c05f180d3f1d466fb7172e266ad24b2ae0b146863efe5ca5920ce57.css integrity="sha256-ZMTM9JwF8YDT8dRm+3Fy4matJLKuCxRoY+/lylkgzlc=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/zh.search.min.9a0c2fbbd9f49c8679c900e51efa0b3d4cd637566f42b994ae894aeb8b4c1652.js integrity="sha256-mgwvu9n0nIZ5yQDlHvoLPUzWN1ZvQrmUrolK64tMFlI=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/j.png alt=Logo class=book-icon><span>老J的博客</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><img src=/images/avatar.jpg width=150 style=border-radius:8px><p style=display:flex;align-items:center;margin-bottom:2px><svg width="24" height="24" viewBox="0 0 30 30"><path d="M15 3C8.373 3 3 8.373 3 15c0 5.623 3.872 10.328 9.092 11.63C12.036 26.468 12 26.28 12 26.047v-2.051c-.487.0-1.303.0-1.508.0-.821.0-1.551-.353-1.905-1.009-.393-.729-.461-1.844-1.435-2.526-.289-.227-.069-.486.264-.451.615.174 1.125.596 1.605 1.222.478.627.703.769 1.596.769.433.0 1.081-.025 1.691-.121.328-.833.895-1.6 1.588-1.962-3.996-.411-5.903-2.399-5.903-5.098.0-1.162.495-2.286 1.336-3.233C9.053 10.647 8.706 8.73 9.435 8c1.798.0 2.885 1.166 3.146 1.481C13.477 9.174 14.461 9 15.495 9c1.036.0 2.024.174 2.922.483C18.675 9.17 19.763 8 21.565 8c.732.731.381 2.656.102 3.594.836.945 1.328 2.066 1.328 3.226.0 2.697-1.904 4.684-5.894 5.097C18.199 20.49 19 22.1 19 23.313v2.734c0 .104-.023.179-.035.268C23.641 24.676 27 20.236 27 15 27 8.373 21.627 3 15 3z"/></svg>
<a href=https://github.com/llaoj target=_blank style=padding-left:5px;padding-top:5px>github.com/llaoj</a></p><p style=display:flex;align-items:center;margin-top:2px><svg width="24" height="24" style="padding-left:4px" enable-background="new 0 0 2499.7 2024.2" viewBox="0 0 2499.7 2024.2"><path d="m2499.7 1313.8c0-347.3-335.9-630.6-749.5-630.6S1003 966.5 1003 1313.8s335.9 630.6 749.5 630.6c80 0 155.4-9.1 226.2-29.7 20.6-4.6 43.4-2.3 64 6.9l185.1 100.5c11.4 6.9 27.4-4.6 22.8-18.3l-36.6-148.5c-4.6-22.8 2.3-45.7 22.8-59.4 160.1-116.5 262.9-287.9 262.9-482.1zm-1016.8-82.2c-57.1.0-102.8-45.7-102.8-102.8s45.7-102.8 102.8-102.8 102.8 45.7 102.8 102.8-45.7 102.8-102.8 102.8zm505 0c-57.1.0-102.8-45.7-102.8-102.8s45.7-102.8 102.8-102.8 102.8 45.7 102.8 102.8-48 102.8-102.8 102.8z"/><path d="m941.4 1316.1c0-386.1 365.6-699.2 818-699.2h34.3c-73.2-349.6-443.3-616.9-888.9-616.9-500.4.0-904.8 333.6-904.8 747.2.0 228.5 125.7 434.1 322.2 571.2 13.7 9.1 18.3 25.1 16 41.1l-68.5 242.2c-4.6 16 13.7 32 29.7 22.8l267.3-159.9c18.3-11.4 38.8-13.7 59.4-6.9 89.1 22.8 182.8 36.6 278.8 36.6 20.6.0 41.1.0 64-2.3-18.4-57.1-27.5-116.5-27.5-175.9zm267.3-920.8c66.3.0 121.1 54.8 121.1 121.1s-54.8 121.1-121.1 121.1-121.1-54.8-121.1-121.1 54.9-121.1 121.1-121.1zM600.9 637.5c-66.3.0-121.1-54.8-121.1-121.1s54.8-121.1 121.1-121.1S722 450.1 722 516.4s-52.5 121.1-121.1 121.1z"/></svg>
<span style=padding-left:5px;padding-top:5px>微信号: holdonwwy</span></p><ul><li><a href=/posts/>文章</a></li></ul><ul><li><span>我的项目</span><ul><li><a href=/docs/mywork/gcopy/>GCopy</a></li><li><a href=/docs/mywork/oauth2nsso/>OAuth2&amp;SSO</a></li><li><a href=/docs/mywork/kubefinder/>KubeFinder</a></li></ul></li><li><a href=/docs/about/>关于我</a><ul></ul></li></ul><ul><li><a href=https://www.cncf.io/ target=_blank rel=noopener>CNCF</a></li><li><a href=https://ebpf.io/ target=_blank rel=noopener>eBPF</a></li></ul><div class=book-menu-after><a href=https://www.rutron.net/ target=_blank>@如创科技</a><br>提供云计算支持</p></div></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Index</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#目前的方案>目前的方案</a><ul><li><a href=#痛点>痛点</a></li></ul></li><li><a href=#1-升级现有方案>1 升级现有方案</a></li><li><a href=#2-promtaillokigrafana>2 promtail+loki+grafana</a><ul><li><a href=#loki-vs-es>loki vs es</a></li><li><a href=#查询语言>查询语言</a></li><li><a href=#节点代理-promtail-vs-fluentd>节点代理 promtail vs fluentd</a></li><li><a href=#用户交互-grafna-vs-kibana>用户交互 grafna vs kibana</a></li><li><a href=#特点和优势>特点和优势</a></li><li><a href=#缺点>缺点</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li><li><a href=#w3-进一步测试并细化loki方案>W3: 进一步测试并细化Loki方案</a><ul><li><a href=#高可用架构>高可用架构</a></li></ul></li></ul></nav></aside></header><article class="markdown book-post"><h2>Index</h2><div class=book-post-content><h1 id=kubernetes相关日志方案>Kubernetes相关日志方案
<a class=anchor href=#kubernetes%e7%9b%b8%e5%85%b3%e6%97%a5%e5%bf%97%e6%96%b9%e6%a1%88>#</a></h1><h2 id=目前的方案>目前的方案
<a class=anchor href=#%e7%9b%ae%e5%89%8d%e7%9a%84%e6%96%b9%e6%a1%88>#</a></h2><p>目前的方案简单概括来说是: fluentd(daemonset)+es+kibana. 使用fluentd在集群每个节点运行一个fluentd实例采集日志通过调用k8s接口为每个日志添加kubernetes和container相关的标签, 然后直接发送到es存储.</p><h3 id=痛点>痛点
<a class=anchor href=#%e7%97%9b%e7%82%b9>#</a></h3><ul><li>es集群的维护成本较高, 比如索引的管理和优化, 集群规模的维护等. 需要技术和经验的加持, 故障处理效率不高.</li><li>es日志需要多副本, 并对整个文档进行索引, 占用资源较多.</li><li>fluentd直接推送到es, 中间少了流量缓冲.(fluentd自带缓冲区,该问题可有所缓解).</li><li>fluentd配置复杂</li></ul><p>下面的方案会针对当前的方案提出, 分析与当前方案的优劣比较:</p><h2 id=1-升级现有方案>1 升级现有方案
<a class=anchor href=#1-%e5%8d%87%e7%ba%a7%e7%8e%b0%e6%9c%89%e6%96%b9%e6%a1%88>#</a></h2><ul><li>节点代理升级为FluentBit, flb使用golang开发速度比flentd快, 而且资源占用也较低. 也已经从cncf毕业.</li><li>增加Kafka流量削峰, 虽然flentbit有缓冲机制, 再增加kafka能进一步增加故障/流量高峰缓冲的能力.<ul><li>增加kafka之后, 推送到es是有消费者来完成的. 日志的流计算、解析、索引的控制不再依赖fluentbit, 相对自由.</li></ul></li><li>优化索引机制, 通过配置可以实现:<ul><li>按照集群每日一个索引(当前策略)</li><li>按照租户每日一个索引</li></ul></li></ul><h2 id=2-promtaillokigrafana>2 promtail+loki+grafana
<a class=anchor href=#2-promtaillokigrafana>#</a></h2><h3 id=loki-vs-es>loki vs es
<a class=anchor href=#loki-vs-es>#</a></h3><p>二者最大的不同是索引, loki被设计成使用最小的索引, 但是es是全文索引, 而且每个字段都有数据结构. 所以, loki有好的性能和资源消耗. 但是富文本搜索的能力不及es.</p><p>loki存储可以使用的后端存储有很多, 比如本地文件系统或者使用对象存储(s3兼容), 这也是它的优势, 更适合云环境, 这将进一步降低成本.</p><h3 id=查询语言>查询语言
<a class=anchor href=#%e6%9f%a5%e8%af%a2%e8%af%ad%e8%a8%80>#</a></h3><p>kibana自己有个KQL语言或者也可以使用lucene查询语法, 这个使用的时间比较长了, 网上有很多查询例子.</p><p>loki使用logQL查询日志, 主要包含两个部分, 一个是标签选择器, 一个是日志过滤表达式. 查询性能与标签选择有关系, 标签选择的日志量大查询时间就长. 语法上相比上面两个相对简单. 这里是一个例子:</p><p><code>{container="query-frontend",namespace="loki-dev"} |= "metrics.go" | logfmt | duration > 10s and throughput_mb &lt; 500</code></p><p><code>{}</code>中的是标签选择器, 选择loki-dev/query-frontend容器中的日志. 后面部分是过滤器, 过滤包含metrics.go关键词的日志, 并将其按照logfmt格式化, 并按照格式化之后的日志条件筛选.</p><h3 id=节点代理-promtail-vs-fluentd>节点代理 promtail vs fluentd
<a class=anchor href=#%e8%8a%82%e7%82%b9%e4%bb%a3%e7%90%86-promtail-vs-fluentd>#</a></h3><p>promtail与fluentd一样也是在节点上收集日志, 主要三个步骤: 发现目标文件、给日志附加标签、把日志推送到loki. fluentd/fluentbit相较promtail功能丰富一些. promtail和fluentbit使用golang开发, fluentd使用ruby开发, 相较fluentd资源占用较小性能更高.</p><p>同时可见fluentbit可以作为fluentd的替代.</p><h3 id=用户交互-grafna-vs-kibana>用户交互 grafna vs kibana
<a class=anchor href=#%e7%94%a8%e6%88%b7%e4%ba%a4%e4%ba%92-grafna-vs-kibana>#</a></h3><p>因为loki也是grafana labs公司的产品, grafana支持日志的查询, 相比kibana都差不多, 毕竟grafana之前只是kibana的一个分支.</p><p>grafana log</p><p><img src=2023-09-13-09-55-08.png alt></p><p>kibana log</p><p><img src=2023-09-13-09-55-42.png alt></p><h3 id=特点和优势>特点和优势
<a class=anchor href=#%e7%89%b9%e7%82%b9%e5%92%8c%e4%bc%98%e5%8a%bf>#</a></h3><p>loki仅会索引标签和元数据, 日志数据被压缩为chuck存储(类似s3). 因为es支持全文索引, es会索引整个文档, 日志以json形式存储在磁盘中, 比loki占用更多的存储.</p><h3 id=缺点>缺点
<a class=anchor href=#%e7%bc%ba%e7%82%b9>#</a></h3><ul><li>因为只是对元数据和标签索引, loki虽然占用资源比es少, 但是查询能力不及es.</li></ul><h2 id=总结>总结
<a class=anchor href=#%e6%80%bb%e7%bb%93>#</a></h2><p>loki的出现比较契合k8s pod日志存储查询的使用场景. 占用更少的存储空间, 虽然查询能力比es差, 但能满足pod日志查询的使用场景. es虽然在维护和资源消耗上处于劣势, 但是它对查询能力、查询速度、统计、分析上的支持还是要比loki好的.</p><p>这是其他人对两个方案测试的结果, 可以参考:</p><p>引用自:
<a href=https://crashlaker.medium.com/which-logging-solution-4b96ad3e8d21>https://crashlaker.medium.com/which-logging-solution-4b96ad3e8d21</a></p><p><img src=2023-09-13-13-24-54.png alt></p><p>可以看到在摄取数据、磁盘占用上loki有一定优势, 但是在查询/分析上(里面涉及日志某系字段的计算, 比如nginx状态码、延迟)loki却逊色不少.</p><h2 id=参考>参考
<a class=anchor href=#%e5%8f%82%e8%80%83>#</a></h2><p>写本方案阅读了一些资料文献:</p><ul><li>Loki vs Elasticsearch - Which tool to choose for Log Analytics?:
<a href=https://signoz.io/blog/loki-vs-elasticsearch/>https://signoz.io/blog/loki-vs-elasticsearch/</a></li><li>Comparing Logging Solutions:
<a href=https://crashlaker.medium.com/which-logging-solution-4b96ad3e8d21>https://crashlaker.medium.com/which-logging-solution-4b96ad3e8d21</a></li><li>日志分析下ES/ClickHouse/Loki比较与思考:
<a href=https://zhuanlan.zhihu.com/p/396211457>https://zhuanlan.zhihu.com/p/396211457</a></li><li>Loki Filesystem Proc/Cons:
<a href=https://grafana.com/docs/loki/latest/operations/storage/filesystem/>https://grafana.com/docs/loki/latest/operations/storage/filesystem/</a></li></ul><h2 id=w3-进一步测试并细化loki方案>W3: 进一步测试并细化Loki方案
<a class=anchor href=#w3-%e8%bf%9b%e4%b8%80%e6%ad%a5%e6%b5%8b%e8%af%95%e5%b9%b6%e7%bb%86%e5%8c%96loki%e6%96%b9%e6%a1%88>#</a></h2><p>本文主要是从</p><ul><li>维护性</li><li>高可用</li><li>使用体验</li><li>性能上</li><li>磁盘存储
几个方面展开. 并没有关注聚合计算、复杂的查询等方面.</li></ul><h3 id=高可用架构>高可用架构
<a class=anchor href=#%e9%ab%98%e5%8f%af%e7%94%a8%e6%9e%b6%e6%9e%84>#</a></h3><p><img src=2023-09-18-10-29-08.png alt></p><h4 id=monolithic-mode>Monolithic mode
<a class=anchor href=#monolithic-mode>#</a></h4><p>Monolithic mode is useful for getting started quickly to experiment with Loki, as well as for small read/write volumes of up to approximately 100GB per day.</p></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><link rel=stylesheet href=https://unpkg.com/gitalk/dist/gitalk.css><script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script><div id=gitalk-container></div><script type=text/javascript>const gitalk=new Gitalk({clientID:"53c7373e7b1554a4abc3",clientSecret:"7c9dcef80ea6bde5d8695d1ab94bcef87063fb3b",repo:"llaoj.github.io",owner:"llaoj",admin:["llaoj"],id:location.pathname,distractionFreeMode:!1});gitalk.render("gitalk-container")</script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#目前的方案>目前的方案</a><ul><li><a href=#痛点>痛点</a></li></ul></li><li><a href=#1-升级现有方案>1 升级现有方案</a></li><li><a href=#2-promtaillokigrafana>2 promtail+loki+grafana</a><ul><li><a href=#loki-vs-es>loki vs es</a></li><li><a href=#查询语言>查询语言</a></li><li><a href=#节点代理-promtail-vs-fluentd>节点代理 promtail vs fluentd</a></li><li><a href=#用户交互-grafna-vs-kibana>用户交互 grafna vs kibana</a></li><li><a href=#特点和优势>特点和优势</a></li><li><a href=#缺点>缺点</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li><li><a href=#w3-进一步测试并细化loki方案>W3: 进一步测试并细化Loki方案</a><ul><li><a href=#高可用架构>高可用架构</a></li></ul></li></ul></nav></div></aside></main></body></html>