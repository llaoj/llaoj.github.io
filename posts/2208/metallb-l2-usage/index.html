<!doctype html><html lang=zh dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="MetalLB概念安装配置和使用请查看
测试组件的版本情况 # kubernetes: v1.22.8 metellb: v0.10.3 nginx: latest 创建测试应用 # 创建一个nginx服务和service资源:
kubectl -n without-istio create deploy nginx --image=nginx 测试分配IP # 创建loadbalancer类型的service:
kubectl -n without-istio create service loadbalancer nginx --tcp=80:80 查看该service详细配置:
apiVersion: v1 kind: Service metadata: labels: app: nginx namespace: without-istio name: nginx ... spec: allocateLoadBalancerNodePorts: true clusterIP: 10.233.15.89 clusterIPs: - 10.233.15.89 externalTrafficPolicy: Cluster internalTrafficPolicy: Cluster ipFamilies: - IPv4 ipFamilyPolicy: SingleStack ports: - name: 80-80 nodePort: 30662 port: 80 protocol: TCP targetPort: 80 selector: app: nginx sessionAffinity: None type: LoadBalancer status: loadBalancer: ingress: - ip: 10."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="MetalLB二层模式使用指南"><meta property="og:description" content="MetalLB概念安装配置和使用请查看
测试组件的版本情况 # kubernetes: v1.22.8 metellb: v0.10.3 nginx: latest 创建测试应用 # 创建一个nginx服务和service资源:
kubectl -n without-istio create deploy nginx --image=nginx 测试分配IP # 创建loadbalancer类型的service:
kubectl -n without-istio create service loadbalancer nginx --tcp=80:80 查看该service详细配置:
apiVersion: v1 kind: Service metadata: labels: app: nginx namespace: without-istio name: nginx ... spec: allocateLoadBalancerNodePorts: true clusterIP: 10.233.15.89 clusterIPs: - 10.233.15.89 externalTrafficPolicy: Cluster internalTrafficPolicy: Cluster ipFamilies: - IPv4 ipFamilyPolicy: SingleStack ports: - name: 80-80 nodePort: 30662 port: 80 protocol: TCP targetPort: 80 selector: app: nginx sessionAffinity: None type: LoadBalancer status: loadBalancer: ingress: - ip: 10."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.llaoj.cn/posts/2208/metallb-l2-usage/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-08T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-08T00:00:00+00:00"><title>MetalLB二层模式使用指南 | 老J的博客</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.18b5d651e266e5e9cfc7455e2e50eb1b74a62aee16cf204b69de1d9e695276f7.css integrity="sha256-GLXWUeJm5enPx0VeLlDrG3SmKu4WzyBLad4dnmlSdvc=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/zh.search.min.1efe740cb5d14370b8f73e176c7bb498d5c64418b81c36e82576db85f218bbce.js integrity="sha256-Hv50DLXRQ3C49z4XbHu0mNXGRBi4HDboJXbbhfIYu84=" crossorigin=anonymous></script>
<script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script>
<script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?7f5ad4632a1c2df3cd8e1199a7aaf48a",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/j.png alt=Logo><span>老J的博客</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/posts/>文章</a></li></ul><ul><li><a href=/docs/oauth2nsso/>OAuth2&SSO</a><ul><li><a href=/docs/oauth2nsso/configuration/>配置</a></li><li><a href=/docs/oauth2nsso/apis/>API列表</a></li><li><a href=/docs/oauth2nsso/deploy/>部署</a></li><li><a href=/docs/oauth2nsso/note/>说明</a></li><li><a href=/docs/oauth2nsso/demo/>示例</a></li><li><a href=/docs/oauth2nsso/for-client/>接入指引</a></li></ul></li><li><a href=/docs/about/>关于</a><ul></ul></li></ul><ul><li><a href=https://www.cncf.io/ target=_blank rel=noopener>CNCF</a></li><li><a href=https://ebpf.io/ target=_blank rel=noopener>eBPF</a></li></ul><div class=book-menu-after><a href=/docs/rutron/ target=_blank>@如创科技</a><br>提供云计算支持</div></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>MetalLB二层模式使用指南</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#测试组件的版本情况>测试组件的版本情况</a></li><li><a href=#创建测试应用>创建测试应用</a></li><li><a href=#测试分配ip>测试分配IP</a></li><li><a href=#手动指定地址池>手动指定地址池</a></li><li><a href=#手动指定ip>手动指定IP</a></li><li><a href=#当地址池ip不够用时>当地址池IP不够用时</a></li></ul></nav></aside></header><article class=markdown><h1><a href=/posts/2208/metallb-l2-usage/>MetalLB二层模式使用指南</a></h1><h5>2022-8-8</h5><div><a href=/categories/technology/>technology</a></div><div><a href=/tags/metallb/>metallb</a></div><p><a href=/posts/2205/metalb/>MetalLB概念安装配置和使用请查看</a></p><h2 id=测试组件的版本情况>测试组件的版本情况
<a class=anchor href=#%e6%b5%8b%e8%af%95%e7%bb%84%e4%bb%b6%e7%9a%84%e7%89%88%e6%9c%ac%e6%83%85%e5%86%b5>#</a></h2><ul><li>kubernetes: v1.22.8</li><li>metellb: v0.10.3</li><li>nginx: latest</li></ul><h2 id=创建测试应用>创建测试应用
<a class=anchor href=#%e5%88%9b%e5%bb%ba%e6%b5%8b%e8%af%95%e5%ba%94%e7%94%a8>#</a></h2><p>创建一个nginx服务和service资源:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n without-istio create deploy nginx --image<span style=color:#000;font-weight:700>=</span>nginx
</span></span></code></pre></div><h2 id=测试分配ip>测试分配IP
<a class=anchor href=#%e6%b5%8b%e8%af%95%e5%88%86%e9%85%8dip>#</a></h2><p>创建loadbalancer类型的service:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n without-istio create service loadbalancer nginx --tcp<span style=color:#000;font-weight:700>=</span>80:80
</span></span></code></pre></div><p>查看该service详细配置:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>namespace</span>:<span style=color:#bbb> </span>without-istio<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#555>...</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>allocateLoadBalancerNodePorts</span>:<span style=color:#bbb> </span><span style=color:#000;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>clusterIP</span>:<span style=color:#bbb> </span><span style=color:#099>10.233.15.89</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>clusterIPs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:#099>10.233.15.89</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>externalTrafficPolicy</span>:<span style=color:#bbb> </span>Cluster<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>internalTrafficPolicy</span>:<span style=color:#bbb> </span>Cluster<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>ipFamilies</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- IPv4<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>ipFamilyPolicy</span>:<span style=color:#bbb> </span>SingleStack<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>ports</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span><span style=color:#099>80-80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>nodePort</span>:<span style=color:#bbb> </span><span style=color:#099>30662</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>port</span>:<span style=color:#bbb> </span><span style=color:#099>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>targetPort</span>:<span style=color:#bbb> </span><span style=color:#099>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>selector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>app</span>:<span style=color:#bbb> </span>nginx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>sessionAffinity</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>type</span>:<span style=color:#bbb> </span>LoadBalancer<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:navy>status</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:navy>loadBalancer</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:navy>ingress</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:navy>ip</span>:<span style=color:#bbb> </span><span style=color:#099>10.206.65.234</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>可以发现external-ip已经完成分配.</p><p>在同一个局域网内, 使用curl命令测试联通情况:</p><p><img src=images/index/20220822163315.png alt=pasted-image></p><p>可以看到, 是可以正常访问的.</p><h2 id=手动指定地址池>手动指定地址池
<a class=anchor href=#%e6%89%8b%e5%8a%a8%e6%8c%87%e5%ae%9a%e5%9c%b0%e5%9d%80%e6%b1%a0>#</a></h2><p>默认, metallb会从所有的可用地址池中分配IP, 除非我们关闭某一个地址池的自动分配<code>auto-assign: false</code>.</p><p>metallb v0.12之前都是用configmap进行配置, 而不是用CRD. 这里是
<a href=https://github.com/metallb/metallb/blob/v0.10.3/website/content/configuration/_index.md>配置相关文档</a>.</p><p>下面我们让集群中有两个地址池, 其中一个关闭自动分配. 修改metallb的配置文件, 增加一个address-pools(expensive), 地址范围10.206.65.224-10.206.65.233, 如下:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n metallb-system edit cm config
</span></span></code></pre></div><p>可以看到目前有两个地址池, 同时配置<code>auto-assign: false</code>来关闭对expensive地址池的自动分配. 配置完毕之后, metallb会重新加载配置文件, 不需要重启它.</p><p><img src=images/index/20220822173024.png alt=pasted-image></p><p>下面创建一个指定地址池(loadbalanced-manual)的service, 我们看能否正确分配地址:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create -f - <span style=color:#d14>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#d14>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#d14>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#d14>metadata:
</span></span></span><span style=display:flex><span><span style=color:#d14>  name: nginx-manual
</span></span></span><span style=display:flex><span><span style=color:#d14>  namespace: without-istio
</span></span></span><span style=display:flex><span><span style=color:#d14>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#d14>    metallb.universe.tf/address-pool: expensive
</span></span></span><span style=display:flex><span><span style=color:#d14>spec:
</span></span></span><span style=display:flex><span><span style=color:#d14>  ports:
</span></span></span><span style=display:flex><span><span style=color:#d14>  - port: 80
</span></span></span><span style=display:flex><span><span style=color:#d14>    targetPort: 80
</span></span></span><span style=display:flex><span><span style=color:#d14>  selector:
</span></span></span><span style=display:flex><span><span style=color:#d14>    app: nginx
</span></span></span><span style=display:flex><span><span style=color:#d14>  type: LoadBalancer
</span></span></span><span style=display:flex><span><span style=color:#d14>EOF</span>
</span></span></code></pre></div><p>继续查看刚创建的service, 发现IP地址已经成功分配, 而且地址范围也符合预期:</p><p><img src=images/index/20220822173653.png alt=pasted-image></p><p>经测试访问正常:</p><p><img src=images/index/20220822173731.png alt=pasted-image></p><h2 id=手动指定ip>手动指定IP
<a class=anchor href=#%e6%89%8b%e5%8a%a8%e6%8c%87%e5%ae%9aip>#</a></h2><p>现在我们看nginx-manual的external-ip是:</p><p><img src=images/index/20220824132218.png alt=pasted-image></p><p>下面我手动将其ip指定为<code>10.206.65.225</code>, 使用如下命令:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n without-istio patch service nginx-manual -p <span style=color:#d14>&#39;
</span></span></span><span style=display:flex><span><span style=color:#d14>{
</span></span></span><span style=display:flex><span><span style=color:#d14>    &#34;spec&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#d14>        &#34;loadBalancerIP&#34;: &#34;10.206.65.225&#34;
</span></span></span><span style=display:flex><span><span style=color:#d14>    }
</span></span></span><span style=display:flex><span><span style=color:#d14>}&#39;</span>
</span></span></code></pre></div><p>请看发生的变化:</p><p><img src=images/index/20220824132351.png alt=pasted-image></p><p>可见external-ip地址按照我们的要求发生了变化. 下面测试下请求连通性:</p><p><img src=images/index/20220824132447.png alt=pasted-image></p><p>访问正常.</p><h2 id=当地址池ip不够用时>当地址池IP不够用时
<a class=anchor href=#%e5%bd%93%e5%9c%b0%e5%9d%80%e6%b1%a0ip%e4%b8%8d%e5%a4%9f%e7%94%a8%e6%97%b6>#</a></h2><p>当前<code>expensive</code>地址池只有两个IP地址:</p><p><img src=images/index/20220830113703.png alt=pasted-image></p><p>这两个地址已经被service占用:</p><p><img src=images/index/20220830114116.png alt=pasted-image></p><p>下面指定该地址池, 创建第三个service, 我们看看会发生什么</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#d14>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#d14>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#d14>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#d14>metadata:
</span></span></span><span style=display:flex><span><span style=color:#d14>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#d14>    metallb.universe.tf/address-pool: expensive
</span></span></span><span style=display:flex><span><span style=color:#d14>  name: nginx-manual-2
</span></span></span><span style=display:flex><span><span style=color:#d14>  namespace: without-istio
</span></span></span><span style=display:flex><span><span style=color:#d14>spec:
</span></span></span><span style=display:flex><span><span style=color:#d14>  ports:
</span></span></span><span style=display:flex><span><span style=color:#d14>  - port: 80
</span></span></span><span style=display:flex><span><span style=color:#d14>    protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#d14>    targetPort: 80
</span></span></span><span style=display:flex><span><span style=color:#d14>  selector:
</span></span></span><span style=display:flex><span><span style=color:#d14>    app: nginx
</span></span></span><span style=display:flex><span><span style=color:#d14>  type: LoadBalancer
</span></span></span><span style=display:flex><span><span style=color:#d14>EOF</span>
</span></span></code></pre></div><p><img src=images/index/20220830114342.png alt=pasted-image></p><p>我们发现, 该service的EXTERNAL-IP处于<code>pending</code>状态, 并且会看到一条Warning级别的事件, 提示地址池中没有可分配的IP了.</p><p>因此, 当地址池中IP数量不够用的时候, Service的EXTERNAL-IP会处于挂起状态, 并发送事件提示地址池中无可分配IP地址.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><link rel=stylesheet href=https://unpkg.com/gitalk/dist/gitalk.css><script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script><div id=gitalk-container></div><script type=text/javascript>const gitalk=new Gitalk({clientID:"53c7373e7b1554a4abc3",clientSecret:"7c9dcef80ea6bde5d8695d1ab94bcef87063fb3b",repo:"llaoj.github.io",owner:"llaoj",admin:["llaoj"],id:location.pathname,distractionFreeMode:!1});gitalk.render("gitalk-container")</script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#测试组件的版本情况>测试组件的版本情况</a></li><li><a href=#创建测试应用>创建测试应用</a></li><li><a href=#测试分配ip>测试分配IP</a></li><li><a href=#手动指定地址池>手动指定地址池</a></li><li><a href=#手动指定ip>手动指定IP</a></li><li><a href=#当地址池ip不够用时>当地址池IP不够用时</a></li></ul></nav></div></aside></main></body></html>