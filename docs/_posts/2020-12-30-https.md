---
layout: post
title: "我悟了, https全流程揭秘"
categories: diary
---

从我们请求 `https://llaoj.cn` 开始

### 1. 通过443端口 浏览器和服务器确定 数据传输的对称加密密钥key

这一步干啥呢?

一句话: **通过非对称加密算法 传递一个 对称加密的key**

非对称加密算法是 公钥加密, 私钥解密. 公钥和私钥是一对, 反过来也不行.

对于非对称加密算法, 首先 服务器是有私钥的, 那么多网站应用, 浏览器或者操作系统不可能内置, 所以需要服务器下发这个公钥.

但有问题, 公钥不能直接传给浏览器, 因为会被劫持盗用.

所以, 需要引入第三方机构CA, 操作系统原生内置很多根证书[(点我了解下)](#名词2-证书), 证书中就有CA的公钥. CA数量不多, 系统可以内置.

简单来说([点我详细了解](#名词3-证书构建和签发过程)), CA机构会:

```
1. 生成 一对公钥&私钥, 提供给应用服务器和浏览器之间做 非对称加密 用
2. 综合 第1步的公钥 + 基本信息 使用CA的私钥签名, 得到证书(如: cert.pem)
3. 最后, CA机构合并 自己的证书 + 第2步的证书 形成证书链 和 第1步生成的私钥 下发给网站管理员进行部署.
```

这,  就是CA签发证书的过程. 所以, 这一步具体干了啥呢?

那就是

```
浏览器请求443端口
服务器 传输CA机构颁发的证书 给浏览器. 
浏览器通过操作系统内置的 CA证书中的公钥 验证这个证书 并 解密获得 服务器的公钥
浏览器生成 对称加密密钥key, 然后用公钥加密, 再给服务器
服务器私钥解密, 获取 对称加密密钥key

完毕~
```

这样浏览器和服务器之间就完成了 对称机加密密钥`key` 的传递, 之后服务器和浏览器之间就可以进行 对称加密数据传输了.

>其实实际情况可能稍微复杂一点, 第三方CA没有这么勤快, 他们会分包给中间单位对用户提供服务, 所以就存在中间证书颁发机构, 不过原理就是上面说的这样, 无非就是递归处理, 在最终的证书中包含一个各层的证书链而已. [点我详细了解](#名词3-证书构建和签发过程)

### 2. 浏览器和服务器通过80端口进行对称加密通信

此时443端口已经完成了它的使命, 接下来数据真正的交互还是要交给80端口

使用 对称加密密钥, 在80端口进行对称加密数据传输.


### 重点名词解释

#### 名词1. 摘要算法

也叫哈希算法, 它不是加密算法, 是没有办法解的, 类似一篇文章前面的摘要, 比如sha1, sha256, md5...

#### 名词2. 证书

我们的操作系统默认植入了很多证书, 找一下有没有熟悉的, 如下:

![internet](/images/https/internet.png)

证书中包含了很多信息, 如下图:

![cert-content](/images/https/cert-content.png)

重点关注几个字段:

|字段|包含|说明|
|-|-|-|
|使用者|说明了该证书颁发给的域名|比如 llaoj.cn, *.llaoj.cn...|
|公钥|公钥密码算法、密钥长度和使用者公钥内容|浏览器就是用它来和服务器进行真正的数据交互|
|有效期从...到|证书的有效期||

#### 名词3. 证书构建和签发过程

- **根证书** 的构建过程:

1. 生成CA的 非对称加密公私钥`ca_prikey`&`ca_pubkey`
2. 把 CA的公钥`ca_pubkey` + CA基本信息`ca_info`(颁发者,有效期,使用者...) 合并摘要`ca_hash`
3. 用CA的私钥`ca_prikey`对摘要`ca_hash`进行加密, 得到`encode_ca_hash`
4. CA合并 `ca_pubkey`+`ca_info`+`encode_ca_hash` 生成自签名证书`ca.crt`, 它可以用来签署下一级证书

- **中间(二级)证书** 的构建过程:

1. 生成CA2的 非对称加密公私钥`ca2_prikey`&`ca2_pubkey`
2. 把 CA2的公钥`ca2_pubkey` + CA2基本信息`ca2_info` 送到根认证机构CA
3. 根认证机构CA先验证CA2身份, 再附加自己信息`ca_info`, 然后, 合并`ca2_pubkey`+`ca2_info`+`ca_info`进行摘要`ca2_hash`
4. 根认证机构CA使用自己的私钥`ca_prikey`对`ca2_hash`非对称加密, 得到`encode_ca2_hash`
5. CA合并`ca2_pubkey`+`ca2_info`+`ca_info`+`encode_ca2_hash`生成签名数字证书`ca2.crt`, 它也可以签署下一级证书

- **现实中的证书签发**流程:

首先, 我们通常申请的证书都是二级认证机构签发的

1. 用户提交申请, 填写基本信息`s2_info`(域名,验证方式,联系人...)
2. 二级认证机构CA2验证申请人网站所有权, 通常是DNS或者文件验证
3. CA2生成 非对称加密算法的公私钥`s2_pubkey`&`s2_prikey`
4. CA2对`s2_pubkey`+`s2_info`+`ca2_info`进行摘要`s2_hash`
5. CA2用其私钥`ca2_prikey`对`s2_hash`非对称加密, 得到`encode_s2_hash`
6. CA2合并`s2_pubkey`+`s2_info`+`ca2_info`+`encode_s2_hash`生成数字证书`s2.crt`, 它不能用于签署下级证书.
7. CA2将包含了`ca2.crt`+`s2.crt`全部内容的证书链 和 `s2_prikey` 下发给用户

### 参考链接

1. [myssl在线查看证书信息](https://myssl.com/cert_decode.html)
2. [X.509 数字证书的基本原理及应用](https://zhuanlan.zhihu.com/p/36832100)